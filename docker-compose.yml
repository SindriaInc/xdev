version: '3.7'

services:
  # =xdev
  xdev:
    image: "${REGISTRY_PREFIX}sindria-xdev-php:${XDEV_PHP_TAG}"
    container_name: "xdev"
    working_dir: ${XDEV_WORKING_DIR}
    build:
      context: ./src
      shm_size: '2gb'
      args:
        - HOST_USER_UID=${HOST_USER_UID}
        - HOST_DOCKER_GROUP_UID=${HOST_DOCKER_GROUP_UID}  
        - TIMEZONE=${TIMEZONE}  
        - XDEV_WORKING_DIR=${XDEV_WORKING_DIR}
        - XDEV_DISPLAY=${XDEV_DISPLAY}
        - SINDRIA_USER_PASSWORD=${SINDRIA_USER_PASSWORD}
    environment:
        - DISPLAY=${XDEV_DISPLAY}
        - TZ=${TIMEZONE}   
    volumes:
      # System volumes      
      - "/dev/shm:/dev/shm"
      - "/tmp/.X11-unix:/tmp/.X11-unix"
      - "/dev/snd:/dev/snd" 
      - "/dev/dri:/dev/dri"
      - "/run/user/${HOST_USER_UID}/pulse:/run/pulse:ro"
      - "/var/run/docker.sock:/var/run/docker.sock"
      # Config volumes
      - "${APP_CONFIG_PATH}/xdev:/home/sindria/config"
      # Working volumes  
      - "${XDEV_PHP_LOCAL_WORKING_DIR}:${XDEV_PHP_WORKING_DIR}"
      - "${XDEV_PHP_LOCAL_SSH_PATH}:${XDEV_PHP_SSH_PATH}"  
    hostname: "xdev.local"
    networks:
      default:
        ipv4_address: "${SINDRIADOCK_XDEV_PHP_IP_ADDRESS}"
        aliases:
          - "xdev.local"
    devices:
      - "/dev/snd"

# =networks
networks:
  default:
    name: "vpc_xdev"
    driver: bridge
    ipam:
      config:
        - subnet: ${SINDRIADOCK_NETWORK_SUBNET}
